import{_ as we,b as k,d as E,p as Ve,c as L,k as u,a,i as w,I as V,w as t,r as p,E as v,g as he,e as Se,s as Te,o as g,j as r,t as c,x as xe,F as H,y as J,z as Ce}from"./index-BAzr2iUZ.js";import{a as Ue,b as De,u as Re,d as Le,r as Ge,c as Ie,s as Pe}from"./task-B7n8-J7F.js";import{g as ze,a as Fe}from"./server-DI7Mx269.js";const Be={class:"task-detail"},Ee={class:"header"},Me={class:"actions"},Ne={class:"description-content"},Oe={class:"command-content"},$e={class:"card-header"},je={class:"script-content"},qe={class:"card-header"},Ae={class:"log-filter"},He={class:"log-content"},Je={key:0,class:"pagination-container"},Ke={key:0,class:"gpu-limit-container"},Qe={class:"dialog-footer"},We={__name:"detail",setup(Xe){const K=he(),M=Se(),l=k({}),G=k([]),N=k([]),D=k(!1),I=k(null),P=k(!1),O=k([]),z=k(0),$=k(!1),f=E({page:1,limit:20}),j=k([0,1,2,3,4,5,6,7]),n=E({name:"",description:"",server_id:"",priority:5,gpu_limit_enabled:!1,gpu_limit:1,gpu_indices:[]}),Q={name:[{required:!0,message:"请输入任务名称",trigger:"blur"},{min:1,max:100,message:"长度在 1 到 100 个字符",trigger:"blur"}],server_id:[{required:!0,message:"请选择服务器",trigger:"change"}]},y=E({level:"",timeRange:[]}),S=async()=>{$.value=!0;try{const s=await Ue(K.params.id);l.value=s.data||{}}catch(s){console.error("获取任务详情失败:",s),v.error("获取任务详情失败")}finally{$.value=!1}},W=async()=>{try{const s=await ze();G.value=s.items||[]}catch(s){console.error("获取服务器列表失败:",s),v.error("获取服务器列表失败")}},X=async s=>{if(s)try{const e=await Fe(s);N.value=e.data||[],j.value=N.value.map(i=>i.index)}catch(e){console.error("获取服务器GPU信息失败:",e)}},Y=s=>{const e=G.value.find(i=>i.id===s);return e?e.name:s},Z=s=>({running:"success",pending:"warning",stopped:"info",completed:"success",failed:"danger",error:"danger"})[s]||"info",ee=s=>({running:"运行中",pending:"等待中",stopped:"已停止",completed:"已完成",failed:"失败",error:"错误"})[s]||s,te=s=>({command:"命令执行",script:"脚本执行",file_transfer:"文件传输"})[s]||s,ae=s=>({info:"info",warning:"warning",error:"danger",debug:""})[s]||"info",R=s=>s?new Date(s).toLocaleString():"-",le=()=>{n.name=l.value.name,n.description=l.value.description||"",n.server_id=l.value.server_id,n.priority=l.value.priority||5,n.gpu_limit_enabled=!!l.value.gpu_limit,n.gpu_limit=l.value.gpu_limit||1,n.gpu_indices=l.value.gpu_indices||[],X(n.server_id),D.value=!0},se=async()=>{I.value&&await I.value.validate(async s=>{if(s)try{const e={name:n.name,description:n.description,priority:n.priority};n.gpu_limit_enabled&&l.value.type!=="file_transfer"&&(e.gpu_limit=n.gpu_limit,e.gpu_indices=n.gpu_indices),await Re(l.value.id,e),v.success("更新任务成功"),D.value=!1,S()}catch(e){console.error("更新任务失败:",e),v.error("更新任务失败: "+(e.message||"未知错误"))}})},oe=async()=>{try{await Ce.confirm("确定要删除该任务吗？","提示",{type:"warning"}),await Le(l.value.id),v.success("删除任务成功"),M.push("/tasks")}catch(s){s!=="cancel"&&(console.error("删除任务失败:",s),v.error("删除任务失败"))}},ne=async()=>{var s,e,i,d;try{const m=l.value.mongo_task_id||l.value.stream_id||l.value._id||l.value.id,_=await Ge(l.value.id,{mongo_task_id:m});console.log("启动任务响应:",_),v.success("启动任务成功"),l.value.status="running",l.value.updated_at=new Date().toISOString(),setTimeout(()=>{S()},1e3)}catch(m){console.error("启动任务失败:",m);const _=((e=(s=m.response)==null?void 0:s.data)==null?void 0:e.detail)||((d=(i=m.response)==null?void 0:i.data)==null?void 0:d.message)||m.message||"未知错误";if(_.includes("已经运行")||_.includes("already running")){console.log("任务已经在运行中，更新本地状态"),v.info("任务已经在运行中"),l.value.status="running",setTimeout(()=>{S()},1e3);return}v.error(`启动任务失败: ${_}`)}},re=async()=>{var s,e,i,d;try{const m=l.value.mongo_task_id||l.value.stream_id||l.value._id||l.value.id,_=l.value.server_ip;if(m&&_)try{const b=await Ie(m,_);console.log("直接方式停止任务响应:",b),v.success("停止任务成功"),l.value.status="stopped",l.value.updated_at=new Date().toISOString(),setTimeout(()=>{S()},1e3);return}catch(b){console.error("直接方式停止任务失败，尝试常规方式:",b)}const h=await Pe(l.value.id,{mongo_task_id:m});console.log("常规方式停止任务响应:",h),v.success("停止任务成功"),l.value.status="stopped",l.value.updated_at=new Date().toISOString(),setTimeout(()=>{S()},1e3)}catch(m){console.error("停止任务失败:",m);const _=((e=(s=m.response)==null?void 0:s.data)==null?void 0:e.detail)||((d=(i=m.response)==null?void 0:i.data)==null?void 0:d.message)||m.message||"未知错误";if(_.includes("不能停止")||_.includes("already stopped")){v.info("任务已经是停止状态"),l.value.status="stopped",setTimeout(()=>{S()},1e3);return}v.error(`停止任务失败: ${_}`)}},x=async()=>{var s,e;try{P.value=!0;const i={page:f.page,limit:f.limit,level:y.level||void 0,start_time:(s=y.timeRange)!=null&&s[0]?new Date(y.timeRange[0]).toISOString():void 0,end_time:(e=y.timeRange)!=null&&e[1]?new Date(y.timeRange[1]).toISOString():void 0},d=await De(l.value.id,i);O.value=d.items||[],z.value=d.total||0}catch(i){console.error("获取任务日志失败:",i),v.error("获取任务日志失败")}finally{P.value=!1}},ie=()=>{y.level="",y.timeRange=[],f.page=1,x()},ue=()=>{x()},de=()=>{f.page=1,x()},pe=s=>{f.page=s,x()},ce=s=>{f.limit=s,f.page=1,x()},me=()=>{M.push("/tasks")};return Ve(()=>{W(),S(),x()}),(s,e)=>{const i=p("el-button"),d=p("el-descriptions-item"),m=p("el-tag"),_=p("el-descriptions"),h=p("el-card"),b=p("el-col"),C=p("el-row"),U=p("el-option"),F=p("el-select"),_e=p("el-date-picker"),B=p("el-table-column"),ge=p("el-table"),ve=p("el-pagination"),q=p("el-input"),T=p("el-form-item"),A=p("el-input-number"),fe=p("el-switch"),ye=p("el-form"),be=p("el-dialog"),ke=Te("loading");return g(),L("div",Be,[u("div",Ee,[e[18]||(e[18]=u("h2",null,"任务详情",-1)),u("div",Me,[l.value.status==="stopped"?(g(),w(i,{key:0,type:"success",onClick:ne},{default:t(()=>e[13]||(e[13]=[r(" 启动任务 ")])),_:1})):V("",!0),l.value.status==="running"?(g(),w(i,{key:1,type:"warning",onClick:re},{default:t(()=>e[14]||(e[14]=[r(" 停止任务 ")])),_:1})):V("",!0),a(i,{type:"primary",onClick:le},{default:t(()=>e[15]||(e[15]=[r("编辑任务")])),_:1}),a(i,{type:"danger",onClick:oe},{default:t(()=>e[16]||(e[16]=[r("删除任务")])),_:1}),a(i,{onClick:me},{default:t(()=>e[17]||(e[17]=[r("返回")])),_:1})])]),a(C,{gutter:20},{default:t(()=>[a(b,{span:24},{default:t(()=>[a(h,{class:"info-card",shadow:"hover"},{header:t(()=>e[19]||(e[19]=[u("div",{class:"card-header"},[u("span",null,"基本信息")],-1)])),default:t(()=>[a(_,{column:2,border:""},{default:t(()=>[a(d,{label:"任务名称"},{default:t(()=>[r(c(l.value.name),1)]),_:1}),a(d,{label:"状态"},{default:t(()=>[a(m,{type:Z(l.value.status)},{default:t(()=>[r(c(ee(l.value.status)),1)]),_:1},8,["type"])]),_:1}),a(d,{label:"服务器"},{default:t(()=>[r(c(Y(l.value.server_id)),1)]),_:1}),a(d,{label:"GPU索引"},{default:t(()=>{var o;return[r(c(((o=l.value.gpu_indices)==null?void 0:o.join(", "))||"-"),1)]}),_:1}),a(d,{label:"创建时间"},{default:t(()=>[r(c(R(l.value.created_at)),1)]),_:1}),a(d,{label:"更新时间"},{default:t(()=>[r(c(R(l.value.updated_at)),1)]),_:1}),a(d,{label:"开始时间"},{default:t(()=>[r(c(R(l.value.start_time)),1)]),_:1}),a(d,{label:"停止时间"},{default:t(()=>[r(c(R(l.value.stop_time)),1)]),_:1}),a(d,{label:"进程ID"},{default:t(()=>[r(c(l.value.pid||"-"),1)]),_:1}),a(d,{label:"任务类型"},{default:t(()=>[r(c(te(l.value.type)),1)]),_:1})]),_:1})]),_:1})]),_:1})]),_:1}),l.value.description?(g(),w(C,{key:0,gutter:20},{default:t(()=>[a(b,{span:24},{default:t(()=>[a(h,{class:"description-card",shadow:"hover"},{header:t(()=>e[20]||(e[20]=[u("div",{class:"card-header"},[u("span",null,"任务描述")],-1)])),default:t(()=>[u("div",Ne,c(l.value.description||"暂无描述"),1)]),_:1})]),_:1})]),_:1})):V("",!0),l.value.type==="command"&&l.value.command?(g(),w(C,{key:1,gutter:20},{default:t(()=>[a(b,{span:24},{default:t(()=>[a(h,{class:"command-card",shadow:"hover"},{header:t(()=>e[21]||(e[21]=[u("div",{class:"card-header"},[u("span",null,"执行命令")],-1)])),default:t(()=>[u("div",Oe,[u("pre",null,c(l.value.command),1)])]),_:1})]),_:1})]),_:1})):V("",!0),l.value.type==="script"&&l.value.script_content?(g(),w(C,{key:2,gutter:20},{default:t(()=>[a(b,{span:24},{default:t(()=>[a(h,{class:"script-card",shadow:"hover"},{header:t(()=>[u("div",$e,[u("span",null,"脚本内容 ("+c(l.value.script_type||"bash")+")",1)])]),default:t(()=>[u("div",je,[u("pre",null,c(l.value.script_content),1)])]),_:1})]),_:1})]),_:1})):V("",!0),l.value.type==="file_transfer"?(g(),w(C,{key:3,gutter:20},{default:t(()=>[a(b,{span:24},{default:t(()=>[a(h,{class:"transfer-card",shadow:"hover"},{header:t(()=>e[22]||(e[22]=[u("div",{class:"card-header"},[u("span",null,"文件传输信息")],-1)])),default:t(()=>[a(_,{column:1,border:""},{default:t(()=>[a(d,{label:"传输类型"},{default:t(()=>[r(c(l.value.transfer_type==="upload"?"上传":"下载"),1)]),_:1}),a(d,{label:"源路径"},{default:t(()=>[r(c(l.value.source_path),1)]),_:1}),a(d,{label:"目标路径"},{default:t(()=>[r(c(l.value.target_path),1)]),_:1})]),_:1})]),_:1})]),_:1})]),_:1})):V("",!0),a(C,{gutter:20},{default:t(()=>[a(b,{span:24},{default:t(()=>[a(h,{class:"log-card",shadow:"hover"},{header:t(()=>[u("div",qe,[e[26]||(e[26]=u("span",null,"任务日志",-1)),u("div",Ae,[a(F,{modelValue:y.level,"onUpdate:modelValue":e[0]||(e[0]=o=>y.level=o),placeholder:"日志级别",clearable:""},{default:t(()=>[a(U,{label:"信息",value:"info"}),a(U,{label:"警告",value:"warning"}),a(U,{label:"错误",value:"error"}),a(U,{label:"调试",value:"debug"})]),_:1},8,["modelValue"]),a(_e,{modelValue:y.timeRange,"onUpdate:modelValue":e[1]||(e[1]=o=>y.timeRange=o),type:"datetimerange","range-separator":"至","start-placeholder":"开始时间","end-placeholder":"结束时间"},null,8,["modelValue"]),a(i,{type:"primary",onClick:de},{default:t(()=>e[23]||(e[23]=[r("搜索")])),_:1}),a(i,{onClick:ie},{default:t(()=>e[24]||(e[24]=[r("重置")])),_:1}),a(i,{type:"success",onClick:ue},{default:t(()=>e[25]||(e[25]=[r("刷新")])),_:1})])])]),default:t(()=>[u("div",He,[xe((g(),w(ge,{data:O.value,border:"",style:{width:"100%"}},{default:t(()=>[a(B,{prop:"timestamp",label:"时间",width:"180"},{default:t(({row:o})=>[r(c(R(o.timestamp)),1)]),_:1}),a(B,{prop:"level",label:"级别",width:"100"},{default:t(({row:o})=>[a(m,{type:ae(o.level)},{default:t(()=>[r(c(o.level),1)]),_:2},1032,["type"])]),_:1}),a(B,{prop:"message",label:"消息"})]),_:1},8,["data"])),[[ke,P.value]]),z.value>0?(g(),L("div",Je,[a(ve,{"current-page":f.page,"onUpdate:currentPage":e[2]||(e[2]=o=>f.page=o),"page-size":f.limit,"onUpdate:pageSize":e[3]||(e[3]=o=>f.limit=o),"page-sizes":[10,20,50,100],layout:"total, sizes, prev, pager, next, jumper",total:z.value,onSizeChange:ce,onCurrentChange:pe},null,8,["current-page","page-size","total"])])):V("",!0)])]),_:1})]),_:1})]),_:1}),a(be,{title:"编辑任务",modelValue:D.value,"onUpdate:modelValue":e[12]||(e[12]=o=>D.value=o),width:"600px"},{footer:t(()=>[u("span",Qe,[a(i,{onClick:e[11]||(e[11]=o=>D.value=!1)},{default:t(()=>e[27]||(e[27]=[r("取消")])),_:1}),a(i,{type:"primary",onClick:se},{default:t(()=>e[28]||(e[28]=[r("确定")])),_:1})])]),default:t(()=>[a(ye,{ref_key:"taskFormRef",ref:I,model:n,rules:Q,"label-width":"100px"},{default:t(()=>[a(T,{label:"任务名称",prop:"name"},{default:t(()=>[a(q,{modelValue:n.name,"onUpdate:modelValue":e[4]||(e[4]=o=>n.name=o)},null,8,["modelValue"])]),_:1}),a(T,{label:"描述",prop:"description"},{default:t(()=>[a(q,{modelValue:n.description,"onUpdate:modelValue":e[5]||(e[5]=o=>n.description=o),type:"textarea",rows:3},null,8,["modelValue"])]),_:1}),a(T,{label:"服务器",prop:"server_id"},{default:t(()=>[a(F,{modelValue:n.server_id,"onUpdate:modelValue":e[6]||(e[6]=o=>n.server_id=o),placeholder:"选择服务器"},{default:t(()=>[(g(!0),L(H,null,J(G.value,o=>(g(),w(U,{key:o.id,label:o.name,value:o.id},null,8,["label","value"]))),128))]),_:1},8,["modelValue"])]),_:1}),a(T,{label:"优先级",prop:"priority"},{default:t(()=>[a(A,{modelValue:n.priority,"onUpdate:modelValue":e[7]||(e[7]=o=>n.priority=o),min:1,max:10},null,8,["modelValue"])]),_:1}),n.type!=="file_transfer"?(g(),w(T,{key:0,label:"GPU限制"},{default:t(()=>[a(fe,{modelValue:n.gpu_limit_enabled,"onUpdate:modelValue":e[8]||(e[8]=o=>n.gpu_limit_enabled=o)},null,8,["modelValue"]),n.gpu_limit_enabled?(g(),L("div",Ke,[a(T,{label:"使用GPU数量","label-width":"120px"},{default:t(()=>[a(A,{modelValue:n.gpu_limit,"onUpdate:modelValue":e[9]||(e[9]=o=>n.gpu_limit=o),min:0,max:8},null,8,["modelValue"])]),_:1}),a(T,{label:"指定GPU索引","label-width":"120px"},{default:t(()=>[a(F,{modelValue:n.gpu_indices,"onUpdate:modelValue":e[10]||(e[10]=o=>n.gpu_indices=o),multiple:"",placeholder:"请选择GPU索引（可多选）"},{default:t(()=>[(g(!0),L(H,null,J(j.value,o=>(g(),w(U,{key:o,label:`GPU ${o}`,value:o},null,8,["label","value"]))),128))]),_:1},8,["modelValue"])]),_:1})])):V("",!0)]),_:1})):V("",!0)]),_:1},8,["model"])]),_:1},8,["modelValue"])])}}},tt=we(We,[["__scopeId","data-v-fc30c30f"]]);export{tt as default};
