import{_ as Pe,b as r,d as ze,p as Ie,H as Be,c as S,a as t,w as n,r as u,g as De,E as i,e as Le,s as Ge,o as p,x as X,k as c,i as g,j as s,t as m,I as M,B as y,J as Y,D as Z,F as ee,y as ae,O as $e,P as Ee,Q as Ne,z as te}from"./index-BAzr2iUZ.js";import{c as Re,a as qe}from"./server-DI7Mx269.js";import{g as Ae,s as je,a as Fe,d as Me,c as Qe,b as He}from"./tasks-bhOV-jnc.js";const Je={class:"server-tasks-container"},Oe={class:"card-header"},Ke={class:"left"},We={class:"right"},Xe={class:"pagination-container"},Ye={class:"dialog-footer"},Ze={class:"log-toolbar"},ea={class:"log-path"},aa={class:"log-content"},ta={__name:"tasks",setup(la){const P=De();Le();const z=r(!1),I=r(1),B=r(20),k=r(0),h=r({}),b=r([]),Q=r([]),le=r(""),ne=async()=>{try{const e=await Re(P.params.id);h.value=e.data}catch(e){console.error("获取服务器信息失败:",e)}},D=async()=>{z.value=!0;try{const e=await Ae(P.params.id,{page:I.value,pageSize:B.value,search:le.value,server_ip:h.value.ip_address});e&&e.data?e.data.items?(b.value=e.data.items,k.value=e.data.total||e.data.items.length):Array.isArray(e.data)?(b.value=e.data,k.value=e.data.length):(b.value=[],k.value=0,i.warning("没有找到任务数据")):(b.value=[],k.value=0,i.warning("没有找到任务数据"))}catch(e){console.error("获取任务列表失败:",e),b.value=[],k.value=0,e.response&&e.response.status===404?i.warning("该服务器暂无任务数据"):e.response&&e.response.data&&e.response.data.detail?i.error("获取任务列表失败："+e.response.data.detail):i.error("获取任务列表失败，请稍后重试")}finally{z.value=!1}},oe=async()=>{try{const e=await qe(P.params.id);Q.value=e.data}catch(e){console.error("获取GPU列表失败:",e)}},C=r(!1),L=r(null),R=r(!1),o=ze({name:"",type:"",server_ip:"",gpu_indices:[],command:"",work_dir:"",env_vars:[{key:"",value:""}]}),se={name:[{required:!0,message:"请输入任务名称",trigger:"blur"},{min:2,max:50,message:"长度在 2 到 50 个字符",trigger:"blur"}],type:[{required:!0,message:"请选择任务类型",trigger:"change"}],gpu_indices:[{required:!0,message:"请选择GPU",trigger:"change"}],command:[{required:!0,message:"请输入执行命令",trigger:"blur"}],work_dir:[{required:!0,message:"请输入工作目录",trigger:"blur"}]},q=r(!1),A=r(!1),j=r(""),x=r(null),T=r(!1);let G=null;const U=()=>{D()},re=()=>{o.server_ip=h.value.ip_address||"",C.value=!0},ue=()=>{var e;(e=L.value)==null||e.resetFields(),o.name="",o.type="",o.server_ip="",o.gpu_indices=[],o.command="",o.work_dir="",o.env_vars=[{key:"",value:""}]},ie=()=>{o.env_vars.push({key:"",value:""})},de=e=>{o.env_vars.splice(e,1)},pe=async()=>{if(L.value)try{await L.value.validate(),R.value=!0;const e={};o.env_vars.forEach(a=>{a.key&&a.value&&(e[a.key]=a.value)}),await Qe(P.params.id,{name:o.name,type:o.type,server_ip:o.server_ip,gpu_indices:o.gpu_indices,command:o.command,work_dir:o.work_dir,env_vars:e}),i.success("创建任务成功"),C.value=!1,U()}catch(e){console.error("创建任务失败:",e),i.error("创建任务失败")}finally{R.value=!1}},ce=async e=>{try{await Fe(e.id),i.success("启动任务成功"),U()}catch(a){console.error("启动任务失败:",a),i.error("启动任务失败")}},me=e=>{te.confirm(`确定要停止任务 ${e.name} 吗？`,"警告",{confirmButtonText:"确定",cancelButtonText:"取消",type:"warning"}).then(async()=>{try{await je(e.id),i.success("停止任务成功"),U()}catch(a){console.error("停止任务失败:",a),i.error("停止任务失败")}}).catch(()=>{})},ve=async e=>{x.value=e,q.value=!0,await F()},F=async()=>{var e;if((e=x.value)!=null&&e.id){A.value=!0;try{const a=await He(x.value.id);j.value=a.data||"暂无日志内容"}catch(a){console.error("获取任务日志失败:",a),j.value="获取日志失败: "+a.message}finally{A.value=!1}}},fe=()=>{T.value=!T.value,T.value?G=setInterval(F,5e3):clearInterval(G)},_e=e=>{te.confirm(`确定要删除任务 ${e.name} 吗？`,"警告",{confirmButtonText:"确定",cancelButtonText:"取消",type:"warning"}).then(async()=>{try{await Me(e.id),i.success("删除任务成功"),U()}catch(a){console.error("删除任务失败:",a),i.error("删除任务失败")}}).catch(()=>{})},ge=e=>{B.value=e,D()},ye=e=>{I.value=e,D()},ke=e=>({training:"primary",inference:"success",other:"info"})[e]||"info",he=e=>({training:"训练",inference:"推理",other:"其他"})[e]||e,be=e=>({running:"success",stopped:"danger",completed:"info",failed:"warning"})[e]||"info",Ve=e=>({running:"运行中",stopped:"已停止",completed:"已完成",failed:"失败"})[e]||e,we=e=>e!=null&&e.length?e.length<=2?e.join(", "):`${e.length}个`:"无",H=e=>e?new Date(e).toLocaleString("zh-CN"):"-";return Ie(()=>{ne(),oe(),D()}),Be(()=>{G&&clearInterval(G)}),(e,a)=>{var W;const $=u("el-tag"),V=u("el-icon"),d=u("el-button"),f=u("el-table-column"),Ce=u("el-tooltip"),xe=u("el-table"),Te=u("el-pagination"),Ue=u("el-card"),w=u("el-input"),_=u("el-form-item"),E=u("el-option"),J=u("el-select"),Se=u("el-form"),O=u("el-dialog"),K=Ge("loading");return p(),S("div",Je,[t(Ue,null,{header:n(()=>[c("div",Oe,[c("div",Ke,[a[11]||(a[11]=c("span",null,"任务管理",-1)),t($,{class:"ml-2",type:"info"},{default:n(()=>[s(m(h.value.name),1)]),_:1}),h.value.ip_address?(p(),g($,{key:0,type:"success"},{default:n(()=>[s("IP: "+m(h.value.ip_address),1)]),_:1})):M("",!0)]),c("div",We,[t(d,{type:"primary",onClick:U,loading:z.value},{default:n(()=>[t(V,null,{default:n(()=>[t(y(Y))]),_:1}),a[12]||(a[12]=s("刷新 "))]),_:1},8,["loading"]),t(d,{type:"success",onClick:re},{default:n(()=>[t(V,null,{default:n(()=>[t(y(Z))]),_:1}),a[13]||(a[13]=s("新建任务 "))]),_:1})])])]),default:n(()=>[X((p(),g(xe,{data:b.value,border:"",style:{width:"100%"}},{default:n(()=>[t(f,{prop:"name",label:"任务名称","min-width":"150"}),t(f,{prop:"type",label:"任务类型",width:"120"},{default:n(({row:l})=>[t($,{type:ke(l.type)},{default:n(()=>[s(m(he(l.type)),1)]),_:2},1032,["type"])]),_:1}),t(f,{prop:"server_ip",label:"服务器IP",width:"130"},{default:n(({row:l})=>[s(m(l.server_ip||"未知"),1)]),_:1}),t(f,{prop:"status",label:"状态",width:"100",align:"center"},{default:n(({row:l})=>[t($,{type:be(l.status)},{default:n(()=>[s(m(Ve(l.status)),1)]),_:2},1032,["type"])]),_:1}),t(f,{prop:"gpu_indices",label:"GPU",width:"120"},{default:n(({row:l})=>{var v;return[t(Ce,{content:l.gpu_indices.join(", "),placement:"top",disabled:!((v=l.gpu_indices)!=null&&v.length)},{default:n(()=>[c("span",null,m(we(l.gpu_indices)),1)]),_:2},1032,["content","disabled"])]}),_:1}),t(f,{prop:"start_time",label:"开始时间",width:"180"},{default:n(({row:l})=>[s(m(H(l.start_time)),1)]),_:1}),t(f,{prop:"end_time",label:"结束时间",width:"180"},{default:n(({row:l})=>[s(m(H(l.end_time)),1)]),_:1}),t(f,{label:"操作",width:"250",fixed:"right"},{default:n(({row:l})=>[l.status==="running"?(p(),g(d,{key:0,type:"danger",link:"",onClick:v=>me(l)},{default:n(()=>a[14]||(a[14]=[s("停止")])),_:2},1032,["onClick"])):M("",!0),l.status==="stopped"?(p(),g(d,{key:1,type:"success",link:"",onClick:v=>ce(l)},{default:n(()=>a[15]||(a[15]=[s("启动")])),_:2},1032,["onClick"])):M("",!0),t(d,{type:"primary",link:"",onClick:v=>ve(l)},{default:n(()=>a[16]||(a[16]=[s("日志")])),_:2},1032,["onClick"]),t(d,{type:"danger",link:"",onClick:v=>_e(l)},{default:n(()=>a[17]||(a[17]=[s("删除")])),_:2},1032,["onClick"])]),_:1})]),_:1},8,["data"])),[[K,z.value]]),c("div",Xe,[t(Te,{"current-page":I.value,"onUpdate:currentPage":a[0]||(a[0]=l=>I.value=l),"page-size":B.value,"onUpdate:pageSize":a[1]||(a[1]=l=>B.value=l),"page-sizes":[10,20,50,100],total:k.value,layout:"total, sizes, prev, pager, next",onSizeChange:ge,onCurrentChange:ye},null,8,["current-page","page-size","total"])])]),_:1}),t(O,{modelValue:C.value,"onUpdate:modelValue":a[9]||(a[9]=l=>C.value=l),title:"新建任务",width:"600px",onClose:ue},{footer:n(()=>[c("div",Ye,[t(d,{onClick:a[8]||(a[8]=l=>C.value=!1)},{default:n(()=>a[21]||(a[21]=[s("取消")])),_:1}),t(d,{type:"primary",onClick:pe,loading:R.value},{default:n(()=>a[22]||(a[22]=[s(" 确定 ")])),_:1},8,["loading"])])]),default:n(()=>[t(Se,{ref_key:"formRef",ref:L,model:o,rules:se,"label-width":"100px"},{default:n(()=>[t(_,{label:"任务名称",prop:"name"},{default:n(()=>[t(w,{modelValue:o.name,"onUpdate:modelValue":a[2]||(a[2]=l=>o.name=l),placeholder:"请输入任务名称"},null,8,["modelValue"])]),_:1}),t(_,{label:"任务类型",prop:"type"},{default:n(()=>[t(J,{modelValue:o.type,"onUpdate:modelValue":a[3]||(a[3]=l=>o.type=l),placeholder:"请选择任务类型",style:{width:"100%"}},{default:n(()=>[t(E,{label:"训练",value:"training"}),t(E,{label:"推理",value:"inference"}),t(E,{label:"其他",value:"other"})]),_:1},8,["modelValue"])]),_:1}),t(_,{label:"服务器IP",prop:"server_ip"},{default:n(()=>[t(w,{modelValue:o.server_ip,"onUpdate:modelValue":a[4]||(a[4]=l=>o.server_ip=l),placeholder:"服务器IP地址",disabled:!0},null,8,["modelValue"]),a[18]||(a[18]=c("span",{class:"form-help-text"},"IP地址将自动使用服务器配置中的地址",-1))]),_:1}),t(_,{label:"GPU",prop:"gpu_indices"},{default:n(()=>[t(J,{modelValue:o.gpu_indices,"onUpdate:modelValue":a[5]||(a[5]=l=>o.gpu_indices=l),multiple:"",placeholder:"请选择GPU",style:{width:"100%"}},{default:n(()=>[(p(!0),S(ee,null,ae(Q.value,l=>(p(),g(E,{key:l.index,label:"GPU "+l.index,value:l.index},null,8,["label","value"]))),128))]),_:1},8,["modelValue"])]),_:1}),t(_,{label:"命令",prop:"command"},{default:n(()=>[t(w,{modelValue:o.command,"onUpdate:modelValue":a[6]||(a[6]=l=>o.command=l),type:"textarea",rows:3,placeholder:"请输入执行命令"},null,8,["modelValue"])]),_:1}),t(_,{label:"工作目录",prop:"work_dir"},{default:n(()=>[t(w,{modelValue:o.work_dir,"onUpdate:modelValue":a[7]||(a[7]=l=>o.work_dir=l),placeholder:"请输入工作目录"},null,8,["modelValue"])]),_:1}),t(_,{label:"环境变量"},{default:n(()=>[(p(!0),S(ee,null,ae(o.env_vars,(l,v)=>(p(),S("div",{key:v,class:"env-item"},[t(w,{modelValue:l.key,"onUpdate:modelValue":N=>l.key=N,placeholder:"名称",style:{width:"200px"}},null,8,["modelValue","onUpdate:modelValue"]),a[19]||(a[19]=c("span",{class:"env-separator"},"=",-1)),t(w,{modelValue:l.value,"onUpdate:modelValue":N=>l.value=N,placeholder:"值",style:{width:"200px"}},null,8,["modelValue","onUpdate:modelValue"]),t(d,{type:"danger",link:"",onClick:N=>de(v),disabled:v===0&&o.env_vars.length===1},{default:n(()=>[t(V,null,{default:n(()=>[t(y($e))]),_:1})]),_:2},1032,["onClick","disabled"])]))),128)),t(d,{type:"primary",link:"",onClick:ie},{default:n(()=>[t(V,null,{default:n(()=>[t(y(Z))]),_:1}),a[20]||(a[20]=s("添加环境变量 "))]),_:1})]),_:1})]),_:1},8,["model"])]),_:1},8,["modelValue"]),t(O,{modelValue:q.value,"onUpdate:modelValue":a[10]||(a[10]=l=>q.value=l),title:"任务日志 - "+((W=x.value)==null?void 0:W.name),width:"80%",class:"log-dialog"},{default:n(()=>{var l;return[c("div",Ze,[t(d,{type:"primary",size:"small",onClick:F},{default:n(()=>[t(V,null,{default:n(()=>[t(y(Y))]),_:1}),a[23]||(a[23]=s("刷新 "))]),_:1}),t(d,{type:"primary",size:"small",onClick:fe},{default:n(()=>[t(V,null,{default:n(()=>[T.value?(p(),g(y(Ne),{key:1})):(p(),g(y(Ee),{key:0}))]),_:1}),s(" "+m(T.value?"停止自动刷新":"自动刷新"),1)]),_:1},8,["type"]),c("span",ea,m((l=x.value)==null?void 0:l.log_path),1)]),X((p(),S("div",aa,[c("pre",null,m(j.value),1)])),[[K,A.value]])]}),_:1},8,["modelValue","title"])])}}},ra=Pe(ta,[["__scopeId","data-v-3e3fc026"]]);export{ra as default};
