import{_ as ae,b as h,d as A,p as se,g as le,c as x,a as o,w as i,r as f,E as v,e as oe,s as ne,o as g,k as y,x as re,B as T,C as N,F as B,y as $,i as I,j as D,T as ie,t as F,I as O,P as de,Q as ue,O as ce,z as U}from"./index-BAzr2iUZ.js";import{g as pe}from"./servers-D_Ew1Wx1.js";import{g as ge}from"./task-B7n8-J7F.js";import{e as me,a as _e,f as fe,s as ve,d as ye}from"./tasks-bhOV-jnc.js";const he={class:"task-list-container"},be={class:"filter-container"},Ie={class:"operation-buttons"},Te={class:"pagination-container"},we={__name:"list",setup(Ce){oe();const k=le(),C=h(!1),b=h("");h([]);const m=h([]),E=h([]),L=h([{label:"运行中",value:"running"},{label:"等待中",value:"pending"},{label:"已完成",value:"completed"},{label:"已失败",value:"failed"},{label:"已取消",value:"canceled"},{label:"已停止",value:"stopped"},{label:"重试中",value:"retry"}]),R=h([{label:"正常",value:0},{label:"已删除",value:1}]),d=A({status:"",serverId:"",serverIp:"",startDate:"",endDate:"",isDeleted:0}),c=A({currentPage:1,pageSize:10,total:0});h(!0);const _=async(e=1,a=c.pageSize)=>{C.value=!0;try{const s={page:e,page_size:a,status:d.status,server_id:d.serverId,server_ip:d.serverIp,keyword:b.value,start_date:d.startDate,end_date:d.endDate,is_deleted:d.isDeleted};Object.keys(s).forEach(n=>{(s[n]===void 0||s[n]==="")&&delete s[n]}),console.log("发送请求参数:",s);let l;parseInt(s.is_deleted)===1?(console.log("使用已删除任务专用API"),l=await ge(s)):(console.log("使用普通任务API"),l=await me(s)),console.log("API原始响应:",l),l?(console.log("处理前的响应数据:",l),l.items?(m.value=l.items,c.total=l.total||l.items.length):l.data&&l.data.items?(m.value=l.data.items,c.total=l.data.total||l.data.items.length):Array.isArray(l)?(m.value=l,c.total=l.length):(console.log("响应数据格式不符合预期"),m.value=[],c.total=0),m.value.length>0&&console.log("任务列表是否包含已删除任务:",m.value.map(n=>({id:n.id,name:n.name,is_deleted:n.is_deleted}))),console.log("搜索结果:",{关键词:b.value,总数:c.total,当前页数据:m.value.map(n=>({id:n.id,name:n.name,status:n.status,is_deleted:n.is_deleted}))})):(console.log("响应数据为空"),m.value=[],c.total=0)}catch(s){console.error("获取任务列表失败:",s),s.response&&(console.error("错误响应:",s.response),console.error("错误数据:",s.response.data)),v.error("获取任务列表失败: "+(s.message||"未知错误")),m.value=[],c.total=0}finally{C.value=!1}},j=async()=>{try{const e=await pe();E.value=e.items||[]}catch(e){console.error("获取服务器列表失败:",e)}},S=()=>{console.log("执行搜索，关键词:",b.value),c.currentPage=1,_(1,c.pageSize)};let z=null;const q=e=>{z&&clearTimeout(z),z=setTimeout(()=>{console.log("搜索输入:",e),b.value=e,S()},300)},Q=()=>{d.status="",d.serverId="",d.serverIp="",d.startDate="",d.endDate="",d.isDeleted=0,b.value="",S()},V=()=>{console.log("筛选条件变化:",d),S()},G=e=>{c.currentPage=e,_(e,c.pageSize)},H=e=>{c.pageSize=e,c.currentPage=1,_(1,e)},J=e=>{U.confirm(`确认停止任务 "${e.name}"？`,"确认",{confirmButtonText:"确认",cancelButtonText:"取消",type:"warning"}).then(async()=>{var a,s,l,n,u;try{const r=e.mongo_task_id||e.stream_id||e._id||e.id,p=e.server_ip;if(console.log("准备停止任务，任务信息:",{id:e.id,name:e.name,status:e.status,mongo_task_id:e.mongo_task_id,stream_id:e.stream_id,server_ip:e.server_ip,使用的ID:r}),r&&p)try{const w=await fe(r,p);console.log("通过直接方式停止任务成功，响应：",w),v.success("任务已成功停止"),e.status="stopped",e.updated_at=new Date().toISOString(),setTimeout(()=>{_()},1e3);return}catch(w){console.error("直接方式停止任务失败，尝试常规方式:",w)}const P=await ve(e.id,{mongo_task_id:r});console.log("常规方式停止任务成功，响应：",P),v.success("任务已停止"),e.status="stopped",e.updated_at=new Date().toISOString(),setTimeout(()=>{_()},1e3)}catch(r){console.error("停止任务失败:",r);const p=((s=(a=r.response)==null?void 0:a.data)==null?void 0:s.detail)||((n=(l=r.response)==null?void 0:l.data)==null?void 0:n.message)||r.message||"未知错误";if(p.includes("不能停止")||p.includes("already stopped")){console.log("任务已经是停止状态，自动刷新列表"),v.info("任务已经是停止状态"),e.status="stopped",setTimeout(()=>{_()},1e3);return}console.error("错误详情:",{statusCode:(u=r.response)==null?void 0:u.status,message:p,taskId:e.id,mongoTaskId:e.mongo_task_id}),v.error(`停止任务失败: ${p}`)}}).catch(()=>{})},K=e=>{U.confirm(`确认重新运行任务 "${e.name}"？`,"确认",{confirmButtonText:"确认",cancelButtonText:"取消",type:"info"}).then(async()=>{var a,s,l,n;try{const u=e.mongo_task_id||e.stream_id||e._id||e.id,r=e.server_ip;console.log("准备运行任务，任务信息:",{id:e.id,name:e.name,status:e.status,mongo_task_id:e.mongo_task_id,stream_id:e.stream_id,使用的ID:u});const p=await _e(e.id,{mongo_task_id:u});console.log("运行任务成功，响应：",p),v.success("任务已启动"),e.status="running",e.updated_at=new Date().toISOString(),setTimeout(()=>{_()},1e3)}catch(u){console.error("运行任务失败:",u);const r=((s=(a=u.response)==null?void 0:a.data)==null?void 0:s.detail)||((n=(l=u.response)==null?void 0:l.data)==null?void 0:n.message)||u.message||"未知错误";if(r.includes("已经运行")||r.includes("already running")){console.log("任务已经在运行中，更新本地状态"),v.info("任务已经在运行中"),e.status="running",setTimeout(()=>{_()},1e3);return}v.error(`运行任务失败: ${r}`)}}).catch(()=>{})},W=e=>{U.confirm(`确认删除任务 "${e.name}"？此操作不可恢复！`,"警告",{confirmButtonText:"确认",cancelButtonText:"取消",type:"error"}).then(async()=>{var a,s,l,n;try{const u=e.stream_id||e._id||e.id,r=await ye(e.id,{mongo_task_id:u});console.log("删除任务成功，响应：",r),v.success("任务已删除"),_()}catch(u){console.error("删除任务失败:",u);const r=((s=(a=u.response)==null?void 0:a.data)==null?void 0:s.detail)||((n=(l=u.response)==null?void 0:l.data)==null?void 0:n.message)||u.message||"未知错误";v.error(`删除任务失败: ${r}`)}}).catch(()=>{})},X=e=>{switch(e){case"running":return"success";case"pending":return"info";case"completed":return"primary";case"failed":return"danger";case"canceled":return"warning";default:return"info"}},Y=e=>{switch(e){case"running":return"运行中";case"pending":return"等待中";case"completed":return"已完成";case"failed":return"已失败";case"canceled":return"已取消";case"stopped":return"已停止";case"retry":return"重试中";default:return e||"未知"}};return se(()=>{console.log("组件挂载，开始初始化"),k.query.server_ip&&(d.serverIp=k.query.server_ip,console.log(`从URL参数获取服务器IP: ${d.serverIp}`)),console.log("开始获取服务器列表"),j(),console.log("开始获取任务列表"),_()}),(e,a)=>{const s=f("el-icon"),l=f("el-input"),n=f("el-option"),u=f("el-select"),r=f("el-button"),p=f("el-table-column"),P=f("el-tag"),w=f("el-table"),Z=f("el-pagination"),ee=f("el-card"),te=ne("loading");return g(),x("div",he,[o(ee,{shadow:"hover",class:"list-card"},{header:i(()=>a[6]||(a[6]=[y("div",{class:"card-header"},[y("div",{class:"header-left"},[y("h2",{class:"section-title"},"任务列表")])],-1)])),default:i(()=>[y("div",be,[o(l,{modelValue:b.value,"onUpdate:modelValue":a[0]||(a[0]=t=>b.value=t),placeholder:"搜索任务名称",style:{width:"200px"},class:"filter-item",clearable:"",onInput:q},{prefix:i(()=>[o(s,null,{default:i(()=>[o(T(N))]),_:1})]),_:1},8,["modelValue"]),o(u,{modelValue:d.status,"onUpdate:modelValue":a[1]||(a[1]=t=>d.status=t),placeholder:"状态",clearable:"",style:{width:"120px"},class:"filter-item",onChange:V},{default:i(()=>[(g(!0),x(B,null,$(L.value,t=>(g(),I(n,{key:t.value,label:t.label,value:t.value},null,8,["label","value"]))),128))]),_:1},8,["modelValue"]),o(u,{modelValue:d.serverId,"onUpdate:modelValue":a[2]||(a[2]=t=>d.serverId=t),placeholder:"服务器",clearable:"",style:{width:"160px"},class:"filter-item",onChange:V},{default:i(()=>[(g(!0),x(B,null,$(E.value,t=>(g(),I(n,{key:t.id,label:t.name,value:t.id},null,8,["label","value"]))),128))]),_:1},8,["modelValue"]),o(u,{modelValue:d.isDeleted,"onUpdate:modelValue":a[3]||(a[3]=t=>d.isDeleted=t),placeholder:"删除状态",style:{width:"120px"},class:"filter-item",onChange:V},{default:i(()=>[(g(!0),x(B,null,$(R.value,t=>(g(),I(n,{key:t.value,label:t.label,value:t.value},null,8,["label","value"]))),128))]),_:1},8,["modelValue"]),o(r,{type:"primary",onClick:S,class:"filter-item"},{default:i(()=>[o(s,null,{default:i(()=>[o(T(N))]),_:1}),a[7]||(a[7]=D(" 搜索 "))]),_:1}),o(r,{type:"info",onClick:Q,class:"filter-item"},{default:i(()=>[o(s,null,{default:i(()=>[o(T(ie))]),_:1}),a[8]||(a[8]=D(" 重置 "))]),_:1})]),re((g(),I(w,{data:m.value,style:{width:"100%"},border:"","empty-text":C.value?"加载中...":"暂无任务数据"},{default:i(()=>[o(p,{prop:"name",label:"任务名称","min-width":"150","show-overflow-tooltip":""}),o(p,{prop:"server_ip",label:"服务器IP",width:"140"},{default:i(({row:t})=>[D(F(t.server_ip||"未知"),1)]),_:1}),o(p,{prop:"status",label:"状态",width:"100"},{default:i(({row:t})=>[o(P,{type:X(t.status||"")},{default:i(()=>[D(F(Y(t.status||"")),1)]),_:2},1032,["type"])]),_:1}),o(p,{prop:"created_at",label:"创建时间",width:"180"}),o(p,{prop:"updated_at",label:"更新时间",width:"180"}),o(p,{label:"操作",width:"250",fixed:"right"},{default:i(({row:t})=>[y("div",Ie,[t.status==="stopped"||t.status==="completed"||t.status==="failed"?(g(),I(r,{key:0,type:"primary",link:"",onClick:M=>K(t)},{default:i(()=>[o(s,null,{default:i(()=>[o(T(de))]),_:1}),a[9]||(a[9]=y("span",null,"运行",-1))]),_:2},1032,["onClick"])):O("",!0),t.status==="pending"||t.status==="running"?(g(),I(r,{key:1,type:"warning",link:"",onClick:M=>J(t)},{default:i(()=>[o(s,null,{default:i(()=>[o(T(ue))]),_:1}),a[10]||(a[10]=y("span",null,"停止",-1))]),_:2},1032,["onClick"])):O("",!0),t.status!=="running"?(g(),I(r,{key:2,type:"danger",link:"",onClick:M=>W(t)},{default:i(()=>[o(s,null,{default:i(()=>[o(T(ce))]),_:1}),a[11]||(a[11]=y("span",null,"删除",-1))]),_:2},1032,["onClick"])):O("",!0)])]),_:1})]),_:1},8,["data","empty-text"])),[[te,C.value]]),y("div",Te,[o(Z,{"current-page":c.currentPage,"onUpdate:currentPage":a[4]||(a[4]=t=>c.currentPage=t),"page-size":c.pageSize,"onUpdate:pageSize":a[5]||(a[5]=t=>c.pageSize=t),"page-sizes":[10,20,50,100],layout:"total, sizes, prev, pager, next, jumper",total:c.total,onSizeChange:H,onCurrentChange:G},null,8,["current-page","page-size","total"])])]),_:1})])}}},Ve=ae(we,[["__scopeId","data-v-be710fea"]]);export{Ve as default};
