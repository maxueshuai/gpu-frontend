const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/alert-7o6wXh13.js","assets/index-BAzr2iUZ.js","assets/index-D0Zj916W.css"])))=>i.map(i=>d[i]);
import{_ as tt,b as y,p as et,c as k,a,w as s,r as i,E as b,q as st,e as at,s as nt,o as c,k as o,t as _,j as u,x as ot,i as C,F as lt,y as rt,z as it}from"./index-BAzr2iUZ.js";import{g as ut,a as ct,b as dt,d as pt}from"./server-DI7Mx269.js";import{g as _t,a as gt}from"./system-CVVitCFZ.js";const vt={class:"dashboard-container"},mt={class:"card-header"},ft={class:"stat-item"},yt={class:"stat-value"},kt={class:"stat-item"},Ct={class:"stat-value"},ht={class:"stat-item"},wt={class:"stat-value"},bt={class:"stat-item"},xt={class:"stat-value warning"},St={class:"card-header"},Mt={key:0},Dt={key:0},At={key:0},Bt={class:"card-header"},Tt={class:"card-header"},Lt={key:1,class:"empty-data"},$t={__name:"index",setup(Pt){let x=null;const m=at(),T=y(!1),d=y({serverCount:0,gpuCount:0,taskCount:0,runningTaskCount:0,alertCount:0,unresolvedAlertCount:0}),S=y([]),A=y(!1),h=y({connected:!1,database:"",collections:0}),M=y([]),P=async()=>{try{const e=await _t();d.value.serverCount=e.server_count,d.value.gpuCount=e.gpu_count,d.value.taskCount=e.task_count,d.value.runningTaskCount=e.running_task_count,d.value.alertCount=e.alert_count,d.value.unresolvedAlertCount=e.unresolved_alert_count}catch(e){console.error("获取系统概览数据失败:",e)}},L=async()=>{A.value=!0;try{const e=await ut();S.value=e.items;const t=[];for(const l of S.value)try{const r=await ct(l.id),w=await dt(l.id);let v=0;if(r&&r.length>0){const p=r.reduce((D,g)=>D+(g.usage||0),0);v=Math.round(p/r.length)}t.push({...l,load:v,cpu_usage:w.cpu_usage||0,memory_usage:w.memory_usage||0})}catch(r){console.error(`获取服务器 ${l.id} 的状态信息失败:`,r),t.push({...l,load:0,cpu_usage:0,memory_usage:0})}S.value=t}catch(e){console.error("获取服务器列表失败:",e),b.error("获取服务器列表失败，请稍后再试")}finally{A.value=!1}},E=async()=>{try{const e=await gt();h.value=e}catch(e){console.error("获取MongoDB状态失败:",e)}},U=async()=>{try{if(!x)try{x=(await st(()=>import("./alert-7o6wXh13.js"),__vite__mapDeps([0,1,2]))).getRecentAlerts}catch(t){console.warn("从alert.js导入失败，尝试本地实现",t),x=(l=10)=>b({message:"无法加载告警数据，请检查网络连接",type:"warning"})}const e=await x(5);M.value=Array.isArray(e)?e:(e==null?void 0:e.items)||[]}catch(e){console.error("获取最近告警失败:",e),M.value=[]}},$=async()=>{T.value=!0;try{await Promise.all([P(),L(),E(),U()])}catch{b.error("获取数据失败")}finally{T.value=!1}},G=()=>{$()},R=async e=>{try{await it.confirm(`确定要删除服务器 ${e.name} 吗？`,"提示",{confirmButtonText:"确定",cancelButtonText:"取消",type:"warning"}),await pt(e.id),b.success("删除成功"),L()}catch(t){t!=="cancel"&&(console.error("删除服务器失败:",t),b.error("删除失败"))}},N=()=>{m.push("/servers/config")},V=e=>{m.push(`/servers/${e}`)},F=e=>{m.push(`/servers/${e}/tasks`)},I=e=>{m.push(`/servers/${e}/alerts`)},O=()=>{m.push("/settings/mongo-servers")},j=()=>{m.push("/alerts/list")},z=e=>{if(!e)return"未知";try{return new Date(e).toLocaleString("zh-CN",{hour12:!1,year:"numeric",month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit"})}catch{return e}},q=e=>({critical:"danger",warning:"warning",info:"info"})[e]||"info",W=e=>({online:"success",offline:"danger",maintenance:"warning",waiting:"info"})[e]||"info",H=e=>({online:"在线",offline:"离线",maintenance:"维护中",waiting:"获取中"})[e]||e;return et(()=>{$()}),(e,t)=>{const l=i("el-button"),r=i("el-col"),w=i("el-row"),v=i("el-card"),p=i("el-table-column"),D=i("el-tag"),g=i("el-progress"),J=i("el-button-group"),K=i("el-table"),B=i("el-descriptions-item"),Q=i("el-descriptions"),X=i("el-timeline-item"),Y=i("el-timeline"),Z=nt("loading");return c(),k("div",vt,[a(w,{gutter:20},{default:s(()=>[a(r,{span:24},{default:s(()=>[a(v,{class:"overview-card"},{header:s(()=>[o("div",mt,[t[1]||(t[1]=o("span",null,"系统概览",-1)),a(l,{type:"primary",onClick:G},{default:s(()=>t[0]||(t[0]=[u("刷新数据")])),_:1})])]),default:s(()=>[a(w,{gutter:20},{default:s(()=>[a(r,{span:6},{default:s(()=>[o("div",ft,[t[2]||(t[2]=o("div",{class:"stat-title"},"服务器总数",-1)),o("div",yt,_(d.value.serverCount||0),1)])]),_:1}),a(r,{span:6},{default:s(()=>[o("div",kt,[t[3]||(t[3]=o("div",{class:"stat-title"},"GPU总数",-1)),o("div",Ct,_(d.value.gpuCount||0),1)])]),_:1}),a(r,{span:6},{default:s(()=>[o("div",ht,[t[4]||(t[4]=o("div",{class:"stat-title"},"运行中任务",-1)),o("div",wt,_(d.value.runningTaskCount||0),1)])]),_:1}),a(r,{span:6},{default:s(()=>[o("div",bt,[t[5]||(t[5]=o("div",{class:"stat-title"},"告警数量",-1)),o("div",xt,_(d.value.alertCount||0),1)])]),_:1})]),_:1})]),_:1})]),_:1}),a(r,{span:24,class:"mt-4"},{default:s(()=>[a(v,null,{header:s(()=>[o("div",St,[t[7]||(t[7]=o("span",null,"服务器状态",-1)),a(l,{type:"success",onClick:N},{default:s(()=>t[6]||(t[6]=[u("添加服务器")])),_:1})])]),default:s(()=>[ot((c(),C(K,{data:S.value,border:""},{default:s(()=>[a(p,{prop:"name",label:"服务器名称","min-width":"120"}),a(p,{prop:"ip_address",label:"IP地址","min-width":"120"}),a(p,{prop:"gpu_count",label:"GPU数量",width:"100"}),a(p,{prop:"status",label:"状态",width:"100"},{default:s(({row:n})=>[a(D,{type:W(n.status)},{default:s(()=>[u(_(H(n.status)),1)]),_:2},1032,["type"])]),_:1}),a(p,{label:"CPU使用率","min-width":"180"},{default:s(({row:n})=>[n.status==="waiting"?(c(),k("div",Mt,[a(g,{percentage:50,status:"",indeterminate:!0,duration:2}),t[8]||(t[8]=o("span",{class:"waiting-text"},"正在获取数据...",-1))])):(c(),C(g,{key:1,percentage:n.cpu_usage||0,status:(n.cpu_usage||0)>80?"exception":""},null,8,["percentage","status"]))]),_:1}),a(p,{label:"内存使用率","min-width":"180"},{default:s(({row:n})=>[n.status==="waiting"?(c(),k("div",Dt,[a(g,{percentage:50,status:"",indeterminate:!0,duration:2}),t[9]||(t[9]=o("span",{class:"waiting-text"},"正在获取数据...",-1))])):(c(),C(g,{key:1,percentage:n.memory_usage||0,status:(n.memory_usage||0)>80?"exception":""},null,8,["percentage","status"]))]),_:1}),a(p,{label:"GPU使用率","min-width":"180"},{default:s(({row:n})=>[n.status==="waiting"?(c(),k("div",At,[a(g,{percentage:50,status:"",indeterminate:!0,duration:2}),t[10]||(t[10]=o("span",{class:"waiting-text"},"正在获取数据...",-1))])):(c(),C(g,{key:1,percentage:n.load||0,status:(n.load||0)>80?"exception":""},null,8,["percentage","status"]))]),_:1}),a(p,{label:"操作",width:"250",fixed:"right"},{default:s(({row:n})=>[a(J,null,{default:s(()=>[a(l,{type:"primary",link:"",onClick:f=>V(n.id)},{default:s(()=>t[11]||(t[11]=[u("详情")])),_:2},1032,["onClick"]),a(l,{type:"success",link:"",onClick:f=>F(n.id)},{default:s(()=>t[12]||(t[12]=[u("任务")])),_:2},1032,["onClick"]),a(l,{type:"warning",link:"",onClick:f=>I(n.id)},{default:s(()=>t[13]||(t[13]=[u("告警")])),_:2},1032,["onClick"]),a(l,{type:"danger",link:"",onClick:f=>R(n)},{default:s(()=>t[14]||(t[14]=[u("删除")])),_:2},1032,["onClick"])]),_:2},1024)]),_:1})]),_:1},8,["data"])),[[Z,A.value]])]),_:1})]),_:1}),a(r,{span:12,class:"mt-4"},{default:s(()=>[a(v,null,{header:s(()=>[o("div",Bt,[t[16]||(t[16]=o("span",null,"MongoDB状态",-1)),a(l,{type:"primary",onClick:O},{default:s(()=>t[15]||(t[15]=[u("配置")])),_:1})])]),default:s(()=>[a(Q,{border:""},{default:s(()=>[a(B,{label:"连接状态"},{default:s(()=>{var n;return[a(D,{type:(n=h.value)!=null&&n.connected?"success":"danger"},{default:s(()=>{var f;return[u(_((f=h.value)!=null&&f.connected?"已连接":"未连接"),1)]}),_:1},8,["type"])]}),_:1}),a(B,{label:"数据库"},{default:s(()=>{var n;return[u(_(((n=h.value)==null?void 0:n.database)||"-"),1)]}),_:1}),a(B,{label:"集合数"},{default:s(()=>{var n;return[u(_(((n=h.value)==null?void 0:n.collections)||0),1)]}),_:1})]),_:1})]),_:1})]),_:1}),a(r,{span:12,class:"mt-4"},{default:s(()=>[a(v,null,{header:s(()=>[o("div",Tt,[t[18]||(t[18]=o("span",null,"最近告警",-1)),a(l,{type:"primary",onClick:j},{default:s(()=>t[17]||(t[17]=[u("查看全部")])),_:1})])]),default:s(()=>[M.value.length>0?(c(),C(Y,{key:0},{default:s(()=>[(c(!0),k(lt,null,rt(M.value,n=>(c(),C(X,{key:n.id,type:q(n.level),timestamp:z(n.time||n.created_at)},{default:s(()=>[u(_(n.message),1)]),_:2},1032,["type","timestamp"]))),128))]),_:1})):(c(),k("div",Lt,"暂无告警数据"))]),_:1})]),_:1})]),_:1})])}}},Rt=tt($t,[["__scopeId","data-v-de4a1cda"]]);export{Rt as default};
