import{_ as we,b as d,p as he,H as be,c as C,x as ke,s as Ce,i as U,w as a,E as b,r as v,g as xe,e as Ae,o as p,a as s,j as f,k as t,t as r,I as S,B as G,J as Q,K as X,L as Pe,M as Ue,N as Ge}from"./index-BAzr2iUZ.js";import{c as Ne,b as $,a as L,s as Ie}from"./server-DI7Mx269.js";const Se={class:"server-detail-container"},De={class:"card-header"},Me={class:"header-left"},Be={class:"server-title"},Te={class:"header-actions"},Ee={key:0,class:"loading-container"},Ve={key:1,class:"error-container"},Re={key:2},$e={class:"server-basic-info"},Le={class:"status-card"},je={class:"status-value"},ze={class:"status-card"},Fe={class:"status-value"},Ke={class:"status-card"},qe={class:"status-value"},He={class:"status-card"},Je={class:"status-value"},Oe={class:"status-card"},We={class:"status-value"},Qe={class:"status-card"},Xe={class:"status-value"},Ye={class:"status-card"},Ze={class:"status-value"},et={class:"status-card"},tt={class:"status-value"},st={class:"card-value"},at={class:"number"},lt={class:"card-value"},ot={class:"number"},rt={class:"card-value"},nt={class:"number"},ut={class:"card-value warning"},it={class:"number"},dt={class:"system-resources"},ct={class:"resource-details"},vt={key:0},_t={key:1},pt={class:"resource-details"},ft={class:"resource-details"},mt={class:"gpu-section"},gt={class:"section-header"},yt={class:"section-actions"},wt={key:2,class:"no-gpu-warning"},ht={class:"memory-usage"},bt={class:"memory-detail"},kt={__name:"detail",props:{id:{type:[Number,String],required:!0}},setup(Y){xe();const Z=Ae(),g=Y,_=d(!1),D=d(!1),j=d(""),N=d(!1),w=d(!0),I=d(null),ee=d(60),M=d({}),o=d({}),u=d([]),te=d(0),se=d(0),ae=d(0),le=d(0);d(!1);const z=d(!1),B=async()=>{_.value=!0,D.value=!1;try{const l=await Ne(g.id);M.value=l;const e=await $(g.id);if(o.value={...e,ip_address:l.ip},e&&e.status!=="waiting")try{const n=await L(g.id);Array.isArray(n)?u.value=n:n&&Array.isArray(n.items)?u.value=n.items:n&&typeof n=="object"?n.items&&Array.isArray(n.items)?u.value=n.items:(console.error("GPU列表数据格式不正确:",n),u.value=[]):u.value=[]}catch(n){console.error("获取GPU列表失败:",n),u.value=[],n.value=!0}else if(e&&e.status==="waiting"){window.retryCount=0,console.log("服务器状态正在获取中，延迟3秒后重试"),setTimeout(()=>{T()},3e3),o.value.status||(o.value={...o.value,status:"waiting",ip_address:l.ip});return}}catch(l){console.error("获取服务器信息失败:",l),D.value=!0,j.value=l.message||"无法连接到服务器，请检查网络连接",b.error("获取服务器信息失败: "+(l.message||"未知错误"))}finally{(!o.value.status||o.value.status!=="waiting")&&(_.value=!1)}},T=async()=>{try{if(window.retryCount||(window.retryCount=0),window.retryCount>10){console.error("服务器状态获取重试次数过多，可能存在问题"),b.warning("服务器状态获取超时，请稍后再试"),_.value=!1,window.retryCount=0;return}const l=await $(g.id);if(l&&l.status==="waiting"){window.retryCount++,console.log(`服务器状态仍在获取中，将再次延迟重试 (${window.retryCount}/10)`),setTimeout(()=>{T()},3e3);return}window.retryCount=0,o.value={...o.value,...l,ip_address:M.value.ip};try{const e=await L(g.id);Array.isArray(e)?u.value=e:e&&Array.isArray(e.items)?u.value=e.items:e&&typeof e=="object"?e.items&&Array.isArray(e.items)?u.value=e.items:(console.error("GPU列表数据格式不正确:",e),u.value=[]):u.value=[]}catch(e){console.error("获取GPU列表失败:",e),u.value=[],e.value=!0}_.value=!1}catch(l){console.error("刷新状态失败:",l),_.value=!1,window.retryCount=0}},F=async()=>{if(!_.value){_.value=!0;try{const l=await $(g.id);if(l&&l.status==="waiting"){window.retryCount=0,console.log("服务器状态为waiting，将延迟处理"),setTimeout(()=>{T()},3e3);return}window.retryCount=0,o.value={...o.value,...l,ip_address:M.value.ip};const e=await L(g.id);Array.isArray(e)?u.value=e:e&&Array.isArray(e.items)?u.value=e.items:e&&typeof e=="object"?e.items&&Array.isArray(e.items)?u.value=e.items:(console.error("GPU列表数据格式不正确:",e),u.value=[]):u.value=[],b({message:"数据已刷新",type:"success",duration:2e3})}catch(l){console.error("刷新服务器状态失败:",l),b.error("刷新失败: "+(l.message||"未知错误")),window.retryCount=0}finally{_.value=!1}}},K=async()=>{if(!N.value){N.value=!0;try{await Ie(g.id),await B(),b.success("GPU信息同步成功")}catch(l){console.error("同步GPU信息失败:",l),b.error("同步GPU信息失败: "+(l.message||"未知错误"))}finally{N.value=!1}}},q=()=>{E(),I.value=setInterval(()=>{w.value&&!_.value&&F()},ee.value*1e3)},E=()=>{I.value&&(clearInterval(I.value),I.value=null)},oe=()=>{w.value=!w.value,w.value?(b.success("已开启自动刷新"),q()):(b.info("已关闭自动刷新"),E())},re=()=>{Z.push(`/servers/${g.id}/edit`)},H=l=>l>=90?"#F56C6C":l>=75?"#E6A23C":"#67C23A",ne=l=>l>=85?"温度过高":l>=75?"温度偏高":"温度正常",ue=l=>l>=85?"temperature danger":l>=75?"temperature warning":"temperature normal",ie=l=>l>=300?"功耗过高":l>=250?"功耗偏高":"功耗正常",de=l=>l>=300?"power critical":l>=250?"power high":"power normal",x=l=>{if(!l||l===0||typeof l!="number")return"N/A";const e=["B","KB","MB","GB","TB"];let n=l,m=0;for(;n>=1024&&m<e.length-1;)n/=1024,m++;return`${n.toFixed(2)} ${e[m]}`},ce=l=>{if(!l&&l!==0)return"N/A";const e=Math.floor(l/86400),n=Math.floor(l%86400/3600),m=Math.floor(l%3600/60);let y="";return e>0&&(y+=`${e}天`),(n>0||e>0)&&(y+=`${n}小时`),y+=`${m}分钟`,y||"刚刚启动"},ve=l=>{if(!l)return new Date().toLocaleString();try{return new Date(l).toLocaleString()}catch{return new Date().toLocaleString()}},J=l=>({online:"success",offline:"danger",maintenance:"warning",waiting:"info"})[l]||"info",O=l=>({online:"在线",offline:"离线",maintenance:"维护中",waiting:"数据获取中"})[l]||l;return he(()=>{B(),w.value&&q()}),be(()=>{E()}),(l,e)=>{const n=v("el-icon"),m=v("el-tag"),y=v("el-tooltip"),A=v("el-button"),_e=v("el-button-group"),pe=v("el-skeleton"),fe=v("el-result"),c=v("el-col"),V=v("el-row"),h=v("el-card"),P=v("el-progress"),W=v("el-alert"),me=v("el-empty"),k=v("el-table-column"),ge=v("el-table"),ye=Ce("loading");return p(),C("div",Se,[ke((p(),U(h,{"element-loading-text":"加载中...",shadow:"hover",class:"main-card"},{header:a(()=>[t("div",De,[t("div",Me,[t("h2",Be,[s(n,null,{default:a(()=>[s(G(Pe))]),_:1}),f(" "+r(o.value.name||"服务器详情"),1)]),s(m,{type:J(o.value.status),class:"status-tag"},{default:a(()=>[f(r(O(o.value.status)),1)]),_:1},8,["type"])]),t("div",Te,[s(y,{content:"自动刷新状态",placement:"top"},{default:a(()=>[s(m,{size:"small",type:w.value?"success":"info",class:"refresh-status"},{default:a(()=>[f(r(w.value?"自动刷新已开启":"自动刷新已关闭"),1)]),_:1},8,["type"])]),_:1}),s(_e,null,{default:a(()=>[s(A,{type:"primary",onClick:oe,loading:_.value,link:""},{default:a(()=>[s(n,null,{default:a(()=>[s(G(Ue))]),_:1}),f(" "+r(w.value?"停止自动刷新":"开启自动刷新"),1)]),_:1},8,["loading"]),s(A,{type:"primary",onClick:F,loading:_.value,link:""},{default:a(()=>[s(n,null,{default:a(()=>[s(G(Q))]),_:1}),e[0]||(e[0]=f(" 刷新 "))]),_:1},8,["loading"]),s(A,{type:"warning",onClick:re,link:""},{default:a(()=>[s(n,null,{default:a(()=>[s(G(Ge))]),_:1}),e[1]||(e[1]=f(" 编辑 "))]),_:1})]),_:1})])])]),default:a(()=>[_.value?(p(),C("div",Ee,[s(pe,{rows:6,animated:""})])):D.value?(p(),C("div",Ve,[s(fe,{icon:"error",title:"获取服务器数据失败","sub-title":j.value},{extra:a(()=>[s(A,{type:"primary",onClick:B},{default:a(()=>e[2]||(e[2]=[f("重试")])),_:1})]),_:1},8,["sub-title"])])):(p(),C("div",Re,[t("div",$e,[e[11]||(e[11]=t("div",{class:"section-title"},"基本信息",-1)),s(V,{gutter:20,class:"status-cards"},{default:a(()=>[s(c,{span:6,xs:12,sm:8,md:6},{default:a(()=>[t("div",Le,[e[3]||(e[3]=t("div",{class:"status-label"},"连接状态",-1)),t("div",je,[s(m,{type:J(o.value.status)},{default:a(()=>[f(r(O(o.value.status)),1)]),_:1},8,["type"])])])]),_:1}),s(c,{span:6,xs:12,sm:8,md:6},{default:a(()=>[t("div",ze,[e[4]||(e[4]=t("div",{class:"status-label"},"主机名",-1)),t("div",Fe,r(o.value.hostname||"未知"),1)])]),_:1}),s(c,{span:6,xs:12,sm:8,md:6},{default:a(()=>[t("div",Ke,[e[5]||(e[5]=t("div",{class:"status-label"},"IP地址",-1)),t("div",qe,r(o.value.ip_address||"N/A"),1)])]),_:1}),s(c,{span:6,xs:12,sm:8,md:6},{default:a(()=>[t("div",He,[e[6]||(e[6]=t("div",{class:"status-label"},"操作系统",-1)),t("div",Je,r(o.value.os_version||"未知"),1)])]),_:1}),s(c,{span:6,xs:12,sm:8,md:6},{default:a(()=>[t("div",Oe,[e[7]||(e[7]=t("div",{class:"status-label"},"运行时间",-1)),t("div",We,r(ce(o.value.uptime)||"N/A"),1)])]),_:1}),s(c,{span:6,xs:12,sm:8,md:6},{default:a(()=>[t("div",Qe,[e[8]||(e[8]=t("div",{class:"status-label"},"最后更新",-1)),t("div",Xe,r(ve(o.value.last_updated)),1)])]),_:1}),s(c,{span:6,xs:12,sm:8,md:6},{default:a(()=>[t("div",Ye,[e[9]||(e[9]=t("div",{class:"status-label"},"CPU 型号",-1)),t("div",Ze,r(o.value.cpu_model||"N/A"),1)])]),_:1}),s(c,{span:6,xs:12,sm:8,md:6},{default:a(()=>[t("div",et,[e[10]||(e[10]=t("div",{class:"status-label"},"CPU 核心数",-1)),t("div",tt,r(o.value.cpu_cores||"N/A"),1)])]),_:1})]),_:1})]),s(V,{gutter:20,class:"info-section"},{default:a(()=>[s(c,{xs:24,sm:12,md:6,lg:6},{default:a(()=>[s(h,{shadow:"hover",class:"info-card"},{header:a(()=>e[12]||(e[12]=[t("div",{class:"card-header"},[t("span",null,"服务器总数")],-1)])),default:a(()=>[t("div",st,[t("span",at,r(te.value),1),e[13]||(e[13]=t("span",{class:"unit"},"台",-1))])]),_:1})]),_:1}),s(c,{xs:24,sm:12,md:6,lg:6},{default:a(()=>[s(h,{shadow:"hover",class:"info-card"},{header:a(()=>e[14]||(e[14]=[t("div",{class:"card-header"},[t("span",null,"GPU总数")],-1)])),default:a(()=>[t("div",lt,[t("span",ot,r(se.value),1),e[15]||(e[15]=t("span",{class:"unit"},"个",-1))])]),_:1})]),_:1}),s(c,{xs:24,sm:12,md:6,lg:6},{default:a(()=>[s(h,{shadow:"hover",class:"info-card"},{header:a(()=>e[16]||(e[16]=[t("div",{class:"card-header"},[t("span",null,"运行任务")],-1)])),default:a(()=>[t("div",rt,[t("span",nt,r(ae.value),1),e[17]||(e[17]=t("span",{class:"unit"},"个",-1))])]),_:1})]),_:1}),s(c,{xs:24,sm:12,md:6,lg:6},{default:a(()=>[s(h,{shadow:"hover",class:"info-card"},{header:a(()=>e[18]||(e[18]=[t("div",{class:"card-header"},[t("span",null,"告警数量")],-1)])),default:a(()=>[t("div",ut,[t("span",it,r(le.value),1),e[19]||(e[19]=t("span",{class:"unit"},"个",-1))])]),_:1})]),_:1})]),_:1}),t("div",dt,[e[23]||(e[23]=t("div",{class:"section-title"},"系统资源",-1)),s(V,{gutter:20},{default:a(()=>[s(c,{span:8,xs:24,sm:12,md:8},{default:a(()=>[s(h,{shadow:"hover",class:"resource-card"},{default:a(()=>[e[20]||(e[20]=t("div",{class:"resource-title"},"CPU 使用率",-1)),s(P,{percentage:Number(o.value.cpu_usage)||0,status:o.value.cpu_usage>80?"exception":null,"stroke-width":18},null,8,["percentage","status"]),t("div",ct,[t("span",null,r(o.value.cpu_usage)+"%",1),o.value.cpu_model?(p(),C("span",vt,r(o.value.cpu_model),1)):S("",!0),o.value.cpu_cores?(p(),C("span",_t,r(o.value.cpu_cores)+" 核",1)):S("",!0)])]),_:1})]),_:1}),s(c,{span:8,xs:24,sm:12,md:8},{default:a(()=>[s(h,{shadow:"hover",class:"resource-card"},{default:a(()=>[e[21]||(e[21]=t("div",{class:"resource-title"},"内存使用率",-1)),s(P,{percentage:Number(o.value.memory_usage)||0,status:o.value.memory_usage>80?"exception":null,"stroke-width":18},null,8,["percentage","status"]),t("div",pt,[t("span",null,r(o.value.memory_usage)+"%",1),t("span",null,"已用: "+r(x(o.value.memory_used)),1),t("span",null,"总计: "+r(x(o.value.memory_total)),1)])]),_:1})]),_:1}),s(c,{span:8,xs:24,sm:12,md:8},{default:a(()=>[s(h,{shadow:"hover",class:"resource-card"},{default:a(()=>[e[22]||(e[22]=t("div",{class:"resource-title"},"磁盘使用率",-1)),s(P,{percentage:Number(o.value.disk_usage)||0,status:o.value.disk_usage>90?"exception":null,"stroke-width":18},null,8,["percentage","status"]),t("div",ft,[t("span",null,r(o.value.disk_usage)+"%",1),t("span",null,"已用: "+r(typeof o.value.disk_used=="string"?o.value.disk_used:x(o.value.disk_used)),1),t("span",null,"总计: "+r(typeof o.value.disk_total=="string"?o.value.disk_total:x(o.value.disk_total)),1)])]),_:1})]),_:1})]),_:1})]),t("div",mt,[t("div",gt,[e[26]||(e[26]=t("h3",{class:"section-title"},"GPU信息",-1)),t("div",yt,[z.value?(p(),U(y,{key:0,content:"GPU信息获取异常，请检查服务器上的NVIDIA驱动",placement:"top"},{default:a(()=>[s(m,{type:"warning",effect:"dark",style:{"margin-right":"10px"}},{default:a(()=>e[24]||(e[24]=[f("GPU数据异常")])),_:1})]),_:1})):S("",!0),s(A,{type:"primary",size:"small",onClick:K,loading:N.value},{default:a(()=>[s(n,null,{default:a(()=>[s(G(Q))]),_:1}),e[25]||(e[25]=f(" 同步GPU信息 "))]),_:1},8,["loading"])])]),z.value?(p(),U(W,{key:0,title:"无法获取GPU信息",type:"warning",description:"请确保服务器已安装NVIDIA驱动，并且有权限执行nvidia-smi命令。","show-icon":"",closable:!1,style:{"margin-bottom":"15px"}})):S("",!0),!u.value||u.value.length===0?(p(),U(me,{key:1,description:"未检测到GPU设备"},{default:a(()=>[s(A,{type:"primary",onClick:K},{default:a(()=>e[27]||(e[27]=[f("重新检测")])),_:1})]),_:1})):u.value[0]&&u.value[0].model==="未安装GPU"?(p(),C("div",wt,[s(W,{title:"未安装GPU或NVIDIA驱动",type:"warning",description:"该服务器未安装GPU设备或未安装NVIDIA驱动，无法获取GPU信息。","show-icon":"",closable:!1})])):(p(),U(ge,{key:3,data:u.value,border:"",style:{width:"100%"},stripe:!0},{default:a(()=>[s(k,{prop:"index",label:"序号",width:"80",align:"center"}),s(k,{prop:"model",label:"型号","min-width":"200","show-overflow-tooltip":""}),s(k,{label:"温度",width:"120",align:"center"},{default:a(({row:i})=>[s(y,{content:ne(i.temperature),placement:"top"},{default:a(()=>[t("span",{class:X(ue(i.temperature))},r(i.temperature)+"°C ",3)]),_:2},1032,["content"])]),_:1}),s(k,{label:"使用率",width:"180",align:"center"},{default:a(({row:i})=>[s(P,{percentage:i.usage,color:H(i.usage),format:R=>R+"%"},null,8,["percentage","color","format"])]),_:1}),s(k,{label:"显存使用率",width:"220",align:"center"},{default:a(({row:i})=>[t("div",ht,[s(P,{percentage:(i.memory_used/i.memory_total*100).toFixed(1),color:H(i.memory_used/i.memory_total*100),format:R=>R+"%"},null,8,["percentage","color","format"]),t("span",bt,r(x(i.memory_used))+" / "+r(x(i.memory_total)),1)])]),_:1}),s(k,{label:"功耗",width:"120",align:"center"},{default:a(({row:i})=>[s(y,{content:ie(i.power_usage),placement:"top"},{default:a(()=>[t("span",{class:X(de(i.power_usage))},r(i.power_usage)+"W ",3)]),_:2},1032,["content"])]),_:1}),s(k,{label:"状态",width:"100",align:"center"},{default:a(({row:i})=>[s(m,{type:i.status==="normal"?"success":"warning"},{default:a(()=>[f(r(i.status==="normal"?"正常":"警告"),1)]),_:2},1032,["type"])]),_:1})]),_:1},8,["data"]))])]))]),_:1})),[[ye,_.value]])])}}},At=we(kt,[["__scopeId","data-v-9e43c1f4"]]);export{At as default};
