import{g as A,a as E,t as P,s as T,d as z,c as I,u as N}from"./mongo-Cu9TCix5.js";import{_ as R,c as B,a,w as t,r as m,b as w,p as j,E as n,z as L,o as U,j as g,t as q,k as M,I as W}from"./index-BAzr2iUZ.js";const F={name:"MongoServers",setup(){const _=w([]),o=w(!1),b=w("add"),l=w(null),p=w(""),y=w({name:"",ip:"",port:27017,username:"",password:"",database:"",auth_source:"admin",collection:"",sync_interval:600}),c={name:[{required:!0,message:"请输入名称",trigger:"blur"}],ip:[{required:!0,message:"请输入IP地址",trigger:"blur"}],port:[{required:!0,message:"请输入端口",trigger:"blur"}],username:[{required:!0,message:"请输入用户名",trigger:"blur"}],password:[{required:!0,message:"请输入密码",trigger:"blur"}],database:[{required:!0,message:"请输入数据库名",trigger:"blur"}],collection:[{required:!0,message:"请输入集合名",trigger:"blur"}],sync_interval:[{required:!0,message:"请输入同步间隔",trigger:"blur"}]},i=async()=>{try{const r=await A();console.log("获取服务器列表响应:",r),Array.isArray(r)?_.value=r:r&&r.data&&Array.isArray(r.data)?_.value=r.data:r&&r.items&&Array.isArray(r.items)?_.value=r.items:(console.error("获取服务器列表格式错误:",r),_.value=[],n.warning("获取服务器列表数据格式异常"))}catch(r){console.error("获取服务器列表错误:",r),n.error("获取服务器列表失败"),_.value=[]}},C=()=>{b.value="add",y.value={name:"",ip:"",port:27017,username:"",password:"",database:"",auth_source:"admin",collection:"",sync_interval:600},p.value="",o.value=!0},k=r=>{b.value="edit";const e={...r,auth_source:r.auth_source||"admin"};y.value={...e},p.value="",o.value=!0},D=async()=>{l.value&&await l.value.validate(async r=>{var e,u;if(r)try{let s;b.value==="add"?(s=await I(y.value),console.log("添加MongoDB服务器响应:",s),n.success("添加成功")):(s=await N(y.value.id,y.value),console.log("更新MongoDB服务器响应:",s),n.success("更新成功")),o.value=!1,setTimeout(()=>{i()},500)}catch(s){console.error("提交表单错误:",s);const v=((u=(e=s.response)==null?void 0:e.data)==null?void 0:u.detail)||(b.value==="add"?"添加失败":"更新失败");n.error(v),p.value=v}})},f=async r=>{try{await L.confirm("确定要删除该服务器吗？","提示",{type:"warning"}),await z(r.id),n.success("删除成功"),i()}catch(e){e!=="cancel"&&n.error("删除失败")}},d=async r=>{try{r.syncing=!0,await T(r.id),n.success("同步任务已启动"),i()}catch{n.error("启动同步失败")}finally{r.syncing=!1}},V=async r=>{try{r.testing=!0;const e=await P(r.id);if(console.log("测试连接响应:",e),e&&e.success===!0)n.success(`连接成功: ${e.message||""}`);else{const u=e&&e.message?e.message:"连接失败";n.error(`连接失败: ${u}`)}}catch(e){console.error("测试连接错误:",e),n.error("测试连接失败")}finally{r.testing=!1}},S=async()=>{l.value&&await l.value.validate(async r=>{var e,u;if(r)try{p.value="";const s=await E(y.value);if(console.log("测试连接参数响应:",s),s&&s.success===!0)n.success(`连接成功: ${s.message||""}`);else{const v=s&&s.message?s.message:"连接失败";n.error(`连接失败: ${v}`),p.value=v}}catch(s){console.error("测试连接参数错误:",s);const v=((u=(e=s.response)==null?void 0:e.data)==null?void 0:u.detail)||"测试连接失败";n.error(v),p.value=v}})},x=r=>r?new Date(r).toLocaleString():"-";return j(()=>{i()}),{servers:_,dialogVisible:o,dialogType:b,formRef:l,form:y,rules:c,errorMsg:p,showAddDialog:C,showEditDialog:k,handleSubmit:D,handleDelete:f,triggerSync:d,testConnection:V,testConnectionParams:S,formatDateTime:x}}},G={class:"mongo-servers"},H={class:"card-header"},J={key:0,class:"error-message"},K={class:"dialog-footer"};function O(_,o,b,l,p,y){const c=m("el-button"),i=m("el-table-column"),C=m("el-tag"),k=m("el-table"),D=m("el-card"),f=m("el-input"),d=m("el-form-item"),V=m("el-input-number"),S=m("el-form"),x=m("el-alert"),r=m("el-dialog");return U(),B("div",G,[a(D,{class:"box-card"},{header:t(()=>[M("div",H,[o[12]||(o[12]=M("span",null,"MongoDB服务器管理",-1)),a(c,{type:"primary",onClick:l.showAddDialog},{default:t(()=>o[11]||(o[11]=[g("添加服务器")])),_:1},8,["onClick"])])]),default:t(()=>[a(k,{data:l.servers,style:{width:"100%"}},{default:t(()=>[a(i,{prop:"name",label:"名称"}),a(i,{prop:"ip",label:"IP地址"}),a(i,{prop:"database",label:"数据库"}),a(i,{prop:"auth_source",label:"认证数据库"}),a(i,{prop:"collection",label:"集合"}),a(i,{prop:"sync_interval",label:"同步间隔(秒)"}),a(i,{prop:"last_sync",label:"最后同步时间"},{default:t(e=>[g(q(l.formatDateTime(e.row.last_sync)),1)]),_:1}),a(i,{prop:"status",label:"状态"},{default:t(e=>[a(C,{type:e.row.status==="正常"?"success":"warning"},{default:t(()=>[g(q(e.row.status),1)]),_:2},1032,["type"])]),_:1}),a(i,{label:"操作",width:"250"},{default:t(e=>[a(c,{size:"small",onClick:u=>l.showEditDialog(e.row)},{default:t(()=>o[13]||(o[13]=[g("编辑")])),_:2},1032,["onClick"]),a(c,{size:"small",type:"success",onClick:u=>l.testConnection(e.row),loading:e.row.testing},{default:t(()=>o[14]||(o[14]=[g(" 测试连接 ")])),_:2},1032,["onClick","loading"]),a(c,{size:"small",type:"primary",onClick:u=>l.triggerSync(e.row),loading:e.row.syncing},{default:t(()=>o[15]||(o[15]=[g(" 同步 ")])),_:2},1032,["onClick","loading"]),a(c,{size:"small",type:"danger",onClick:u=>l.handleDelete(e.row)},{default:t(()=>o[16]||(o[16]=[g(" 删除 ")])),_:2},1032,["onClick"])]),_:1})]),_:1},8,["data"])]),_:1}),a(r,{title:l.dialogType==="add"?"添加MongoDB服务器":"编辑MongoDB服务器",modelValue:l.dialogVisible,"onUpdate:modelValue":o[10]||(o[10]=e=>l.dialogVisible=e),width:"500px"},{footer:t(()=>[M("span",K,[a(c,{onClick:o[9]||(o[9]=e=>l.dialogVisible=!1)},{default:t(()=>o[18]||(o[18]=[g("取消")])),_:1}),a(c,{type:"success",onClick:l.testConnectionParams},{default:t(()=>o[19]||(o[19]=[g("测试连接")])),_:1},8,["onClick"]),a(c,{type:"primary",onClick:l.handleSubmit},{default:t(()=>o[20]||(o[20]=[g("确定")])),_:1},8,["onClick"])])]),default:t(()=>[a(S,{ref:"formRef",model:l.form,rules:l.rules,"label-width":"120px"},{default:t(()=>[a(d,{label:"名称",prop:"name"},{default:t(()=>[a(f,{modelValue:l.form.name,"onUpdate:modelValue":o[0]||(o[0]=e=>l.form.name=e)},null,8,["modelValue"])]),_:1}),a(d,{label:"IP地址",prop:"ip"},{default:t(()=>[a(f,{modelValue:l.form.ip,"onUpdate:modelValue":o[1]||(o[1]=e=>l.form.ip=e)},null,8,["modelValue"])]),_:1}),a(d,{label:"端口",prop:"port"},{default:t(()=>[a(V,{modelValue:l.form.port,"onUpdate:modelValue":o[2]||(o[2]=e=>l.form.port=e),min:1,max:65535},null,8,["modelValue"])]),_:1}),a(d,{label:"用户名",prop:"username"},{default:t(()=>[a(f,{modelValue:l.form.username,"onUpdate:modelValue":o[3]||(o[3]=e=>l.form.username=e)},null,8,["modelValue"])]),_:1}),a(d,{label:"密码",prop:"password"},{default:t(()=>[a(f,{modelValue:l.form.password,"onUpdate:modelValue":o[4]||(o[4]=e=>l.form.password=e),type:"password"},null,8,["modelValue"])]),_:1}),a(d,{label:"数据库",prop:"database"},{default:t(()=>[a(f,{modelValue:l.form.database,"onUpdate:modelValue":o[5]||(o[5]=e=>l.form.database=e)},null,8,["modelValue"])]),_:1}),a(d,{label:"认证数据库",prop:"auth_source"},{default:t(()=>[a(f,{modelValue:l.form.auth_source,"onUpdate:modelValue":o[6]||(o[6]=e=>l.form.auth_source=e),placeholder:"默认为admin"},null,8,["modelValue"]),o[17]||(o[17]=M("div",{class:"form-tip"},"通常使用admin作为认证数据库，除非MongoDB特别配置",-1))]),_:1}),a(d,{label:"集合",prop:"collection"},{default:t(()=>[a(f,{modelValue:l.form.collection,"onUpdate:modelValue":o[7]||(o[7]=e=>l.form.collection=e)},null,8,["modelValue"])]),_:1}),a(d,{label:"同步间隔(秒)",prop:"sync_interval"},{default:t(()=>[a(V,{modelValue:l.form.sync_interval,"onUpdate:modelValue":o[8]||(o[8]=e=>l.form.sync_interval=e),min:60,max:3600},null,8,["modelValue"])]),_:1})]),_:1},8,["model","rules"]),l.errorMsg?(U(),B("div",J,[a(x,{title:l.errorMsg,type:"error",closable:!0,"show-icon":""},null,8,["title"])])):W("",!0)]),_:1},8,["title","modelValue"])])}const Y=R(F,[["render",O],["__scopeId","data-v-f7bbc55a"]]);export{Y as default};
